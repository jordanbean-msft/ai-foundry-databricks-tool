# Troubleshooting

## "Unauthorized" Errors

Verify the managed identity has proper permissions:

```bash
az role assignment list \
  --assignee <principal-id> \
  --all \
  --query "[?contains(scope, 'Databricks')]"
```

## Connection Issues

Check the connection status:

```bash
az cognitiveservices account deployment show \
  --name <account-name> \
  --resource-group <resource-group> \
  --deployment-name databricks_connection
```

## Token Scope Issues

The token must be requested for the Azure Databricks resource ID:
`2ff814a6-3304-4ab8-85cb-cd0e6f879c1d`

This is handled automatically by the connection configuration.

## PAT Expiration

PATs generated by the script have a configurable lifetime (default 90 days, max 730 days).

**To rotate a PAT before expiration:**

1. Run the script again with the same parameters (it will create a new PAT and update the connection)
2. Or provide a new PAT using `--databricks-pat` parameter

**Check PAT expiration:**

The script output JSON includes `pat_lifetime_days` when a PAT is generated. Calculate expiration date from creation time.

## Common Issues

### Import Errors

Ensure all dependencies are installed:

```bash
cd src
uv sync
```

### Azure CLI Not Authenticated

```bash
az login
az account set --subscription <subscription-id>
```

### Invalid Project Endpoint

Ensure the endpoint format is correct:

```
https://<account-name>.services.ai.azure.com/api/projects/<project-name>
```

### Databricks Workspace URL Format

Ensure the workspace URL format is correct:

```
https://adb-<workspace-id>.<region>.azuredatabricks.net
```

## Getting Help

If you encounter issues not covered here:

1. Check the [Azure Databricks REST API documentation](https://docs.databricks.com/api/azure/workspace/introduction)
2. Review [Azure AI Foundry documentation](https://learn.microsoft.com/azure/ai-studio/)
3. Enable debug logging with `--debug` flag when running the script
